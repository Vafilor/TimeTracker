{% extends 'sidebar.html.twig' %}
{% import 'time/partials.html.twig' as time %}
{% import 'tag/partials.html.twig' as tags %}

{% block content_class %}w-100{% endblock %}

{% block title %}TimeTracker{% endblock %}

{% block content_body %}
    <div class="p-3 js-data"
         data-duration-format="{{ app.user.durationFormat }}">
        <h1 class="text-center">Time Entries</h1>

        <div class="filter table-filter mb-3">
            <div class="filter-title">Filter</div>
            {{ form_start(filterForm) }}
            <div class="d-flex flex-wrap mb-2">
                <div class="mr-3">
                    <div>
                    {{ form_label(filterForm.start) }}
                    {% if filterForm.end.vars.errors|length != 0 %}
                        &nbsp;
                    {% endif %}
                    </div>
                    <div class="d-inline-flex mt-1">
                        {{ form_widget(filterForm.start, {attr: {class: 'anti-form-control'}}) }}
                        <button type="button" class="btn btn-danger js-clear-datetime ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <div>
                    {{ form_label(filterForm.end) }}
                    {% if filterForm.start.vars.errors|length != 0 %}
                        &nbsp;
                    {% endif %}
                    </div>
                    <div class="d-inline-flex mt-1">
                        {{ form_widget(filterForm.end, {attr: {class: 'anti-form-control'}}) }}
                        <button type="button" class="btn btn-danger js-clear-datetime ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            {{ form_label(filterForm.tags) }}
            <div class="js-autocomplete-tags d-flex align-items-center mb-1">
                {{ form_widget(filterForm.tags, {attr: {class: 'js-real-input d-none'}}) }}
                <div class="js-tags tag-list many-rows" data-initial-tags-name="{{ app.request.query.get('tags') }}"></div>

                <div class="input-group unset-width flex-shrink-0 align-self-start">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <div class="spinner-border spinner-border-sm text-primary js-loading opacity-invisible" role="status">
                              <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <input type="text" class="js-input" placeholder="tag name..." aria-label="loading indicator">
                    <button type="button" class="btn btn-secondary js-add-tag ml-2">Add</button>
                </div>
            </div>

            {{ form_label(filterForm.taskId) }}
            <div class="js-autocomplete-tasks">
                <div class="input-group unset-width flex-shrink-0 align-self-start">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <div class="spinner-border spinner-border-sm text-primary js-loading opacity-invisible" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <input
                            type="text"
                            class="js-input"
                            placeholder="task name..."
                            aria-label="loading indicator"
                            {% if task %}
                            value="{{ task.name }}"
                            {% endif %}
                    />
                </div>

                {{ form_widget(filterForm.taskId, {attr: {class: 'd-none js-real-task-input'}}) }}
            </div>

            <button type="submit" class="btn btn-primary mt-2">Search</button>
            {{ form_end(filterForm) }}
        </div>

        <div class="dropdown">
            <label>Sort</label>
            <button class="btn dropdown-toggle bg-white border-gray ml-2" type="button" id="time-entry-sort" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {% if pagination.isSorted('time_entry.startedAt') and pagination.direction == 'asc' %}
                    Oldest
                {% else %}
                    Newest
                {% endif %}
            </button>
            <div class="dropdown-menu" aria-labelledby="time-entry-sort">
                {{ knp_pagination_sortable(pagination, 'Newest', 'time_entry.startedAt', { class: 'dropdown-item' }, { direction: 'desc' }, 'pagination/dropdown.html.twig'  ) }}
                {{ knp_pagination_sortable(pagination, 'Oldest', 'time_entry.startedAt', { class: 'dropdown-item' }, { direction: 'asc' }, 'pagination/dropdown.html.twig'  ) }}
            </div>
        </div>

        {{ knp_pagination_render(pagination, null, {}, {'align': 'center'}) }}

        <div class="mb-3">
            <button class="btn btn-primary js-create-time-entry">
                <span class="spinner-border spinner-border-sm d-none js-loading" role="status" aria-hidden="true"></span>
                Create time entry
            </button>
        </div>
        <div class="time-entry-list">
        {% for timeEntry in pagination.items %}
            <div
                class="time-entry js-time-entry"
                data-id="{{ timeEntry.idString }}"
                {% if timeEntry.assignedToTask %}
                data-task-id="{{ timeEntry.task.idString }}"
                data-task-name="{{ timeEntry.task.name }}"
                {% endif %}
            >
                <div class="d-flex justify-content-between">
                    <div>
                        {% if not timeEntry.over %}
                        <div class="ml-2 spinner spinner-border spinner-border-sm text-primary js-time-entry-activity js-loading" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        {% endif %}
                        <div class="task js-task">
                            {% if timeEntry.assignedToTask %}
                                <a class="js-task-content" href="{{ path('task_view', {id: timeEntry.task.id}) }}">{{ timeEntry.task.name }}</a>
                            {% else %}
                                <div class="js-task-content d-inline-block">No Task</div>
                            {% endif %}
                        </div>
                    </div>

                {% if timeEntry.over %}
                    <div
                        class="duration js-duration"
                        data-start="{{ timeEntry.startedAt.timestamp }}">
                        {{ time.user_duration(timeEntry.duration, app.user) }}
                    </div>
                {% else %}
                    <div
                        class="duration js-duration active"
                        data-start="{{ timeEntry.startedAt.timestamp }}">
                        {{ time.user_duration(timeEntry.duration, app.user) }}
                    </div>
                {% endif %}
                </div>
                <div class="tag-list js-tag-list many-rows mt-1" data-initial-tags-name="{{ timeEntry.tagNames() }}">
                    <div class="js-tag-list-view">
                        {% for tag in timeEntry.tags %}
                            {{ tags.view(tag.name, tag.color) }}
                        {% endfor %}
                    </div>
                </div>
                <div class="d-flex js-timestamps">
                    <div class="timestamp js-started-at" data-timestamp="{{ timeEntry.startedAt|date("Y-m-d H:i:s", app.user.timezone) }}">{{ time.user_date(timeEntry.startedAt, app.user) }}</div>

                    <div
                        class="ml-2 timestamp js-ended-at"
                        {% if timeEntry.over %}
                        data-timestamp="{{ timeEntry.endedAt|date("Y-m-d H:i:s", app.user.timezone) }}"
                        {% endif %}>

                        {% if timeEntry.over %}
                        - {{ time.user_date(timeEntry.endedAt, app.user) }}
                        {% endif %}
                    </div>
                </div>
                <div
                    class="js-description mt-2"
                    data-description="{{ timeEntry.description }}">
                    {% if timeEntry.descriptionEmpty %}
                        No description
                    {% else %}
                        {{ timeEntry.description|markdown_to_html }}
                    {% endif %}
                </div>
                <hr/>
                <div class="d-flex justify-content-end js-actions">
                    <a href="{{ path('time_entry_view', {id: timeEntry.idString}) }}" class="btn btn-primary js-view">View</a>
                    <button type="button" class="btn btn-primary js-edit ml-2">Edit</button>
                    <a href="{{ path('time_entry_continue', {id: timeEntry.idString}) }}" class="btn btn-secondary js-continue ml-2">Continue</a>
                    {% if timeEntry.running %}
                        <button data-time-entry-id="{{ timeEntry.idString }}" class="btn btn-danger js-stop ml-2">
                            <span class="spinner-border spinner-border-sm d-none js-loading" role="status" aria-hidden="true"></span>
                            Stop
                        </button>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="text-center">No results found</div>
        {% endfor %}
        </div>

        {{ knp_pagination_render(pagination, null, {}, {'align': 'center'}) }}

        {# Confirm create and stop modal #}
        <div class="modal fade" id="confirm-stop-modal" tabindex="-1" aria-labelledby="confirm-stop-modal-label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirm-stop-modal-label">Stop running time entry?</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        You have a running time entry, stop it and start a new one?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button class="btn btn-danger js-stop-running">Stop</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    {{ encore_entry_link_tags('time_entry_index') }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {{ encore_entry_script_tags('time_entry_index') }}
{% endblock %}
